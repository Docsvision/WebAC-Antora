= Настройки базы данных

На странице настроек сервера приложений отображается блок со списком подключенных баз данных. Каждая БД отображается на новой строке таблицы:

include::partial$excerpts.adoc[tags=dbalias]
include::partial$excerpts.adoc[tags=dbname]
include::partial$excerpts.adoc[tags=servername]
include::partial$excerpts.adoc[tags=dbindex]
include::partial$excerpts.adoc[tags=dbversion]
include::partial$excerpts.adoc[tags=dbupdate]
include::partial$excerpts.adoc[tags=dbcreated]
include::partial$excerpts.adoc[tags=dbdefault]
include::partial$excerpts.adoc[tags=dboff]
include::partial$excerpts.adoc[tags=actionbuttons]

[#settings]
== Настройки БД

Нажатие на строку с именем БД переводит на страницу настроек БД. Страница содержит следующие разделы:

* <<properties,Общие свойства>>
* <<maintenance,Обслуживание>>
* <<storage,Внешние хранилища>>
* <<archive,Архивирование>>
* <<cache,Кэширование>>
* <<log,Журналирование>>
* <<additional,Дополнительные настройки>>

[#properties]
=== Свойства базы данных

Общие свойства::

include::partial$excerpts.adoc[tags=name]

include::partial$excerpts.adoc[tags=servername]

include::partial$excerpts.adoc[tags=servertype]

Версия:::
Версия базы данных.

Дата последнего обновления:::
Дата, когда было выполнено последнее обновление БД.

Использовать по умолчанию:::
Флаг для выбора БД, к которой по умолчанию будут подключаться клиенты и сервисы {dv}.

[#options]
Опции::
Группа настроек позволяет задать место хранения таблиц `ChangeObjectDataBaseType`, `CursorDataBaseType`, `FileCursorDataBaseType`, `IconDataBaseType`, `KeysetDataBaseType`, `SearchDataBaseType`. Доступные варианты расположения:
+
// tag::adv-options[]
* *UseOwnDatabase* -- использовать БД {dv}.
* *UseOuterDatabase* -- использовать сателлитную БД, предназначенную для системных таблиц `Название-БД-Docsvision_Metadata`.
+
[NOTE]
====
Если сателлитная БД `Название-БД-Docsvision_Metadata` не используется, она будет создана. Если сателлитная БД не используется, параметр `UseOuterMetadata` должен иметь значение `*False*`.
====
+
* *UseTemporaryDatabase* -- использовать временную базу данных `tempdb`.
+
.Для служебной таблицы "ChangedObjectDataBaseType" также доступны варианты:
* *InMemoryTableOwnDatabase* -- таблица в памяти SQL-сервера.
* *InMemoryTableOwnDatabaseNotPersistData* -- таблица в памяти SQL-сервера без сохранения данных при перезапуске SQL Server.
// end::adv-options[]
+
Подробнее см. "xref:db-service-tables.adoc[]".

[#maintenance]
=== Обслуживание

Группа настроек "Обслуживание" содержит настройки, связанные с обслуживанием базы данных: настройка пути к файлу сценария обслуживания, настройка очистки корзины, дополнительные настройки.

.Группа настроек "Обслуживание" параметров базы данных {dv}
image::dev@platform:admin:db-management.png[Группа настроек "Обслуживание" параметров базы данных {dv}]

. Блок настроек _Сценарий обслуживания_ -- предоставляет функциональность запуска пользовательского скрипта обслуживания БД:
.. Поле _Путь к файлу сценария_ -- путь к файлу (`.sql`, `.enc`, `.xml`), содержащему пользовательский код обслуживания БД.
.. Поле _Таймаут_ -- период ожидания завершения скрипта. По истечении указанного интервала выполнение скрипта будет прервано с ошибкой. Также устанавливает максимальное время выполнения процедуры `ObjectValidation`. Процедура `ObjectValidation` запускается, когда изменяется местоположение служебных таблиц в разделе настроек <<metadata,Метаданные>>.
.. Кнопка *Выполнить* -- запускает выполнение указанного файла сценария.
. Блок настроек _Корзина_ -- содержит параметры очистки корзины от удалённых (в корзину) карточек:
.. Параметр _Срок хранения карточек_ -- определяет продолжительность нахождения карточки в корзине, по истечении которого задача автоматической или ручной очистки корзины удалит эту карточку.
.. Набор переключателей _Очищать корзину_ -- определяет интервал и время запуска задачи автоматической очистки корзины от карточек, время хранения которых истекло.
.. Кнопка *Очистить* -- удаляет из корзины карточки, время хранения которых истекло.
. {blank}
+
include::partial$excerpts.adoc[tags=takeoffice]
+
. Кнопка *Пересоздать задания БД* -- повторно создаёт в БД задания по очистке корзины, удалению записей из системного журнала, архивированию, используется при непреднамеренном удалении заданий из БД, восстановлении БД.
+
Если для заданий в настройках БД установлено время перезапуска, нажатие на данную кнопку сбрасывает время на стандартные значения. Некоторые задания могут влиять на кэш памяти сервера. В связи с этим стоит помнить, что перезапуск *{sss-new}* следует выполнять после выполнения заданий.

[#archiving]
== Настройки архивирования

.Настройка архивирования в {of-mc}
image::dev@platform:admin:create-panel-archiving.png[Настройка архивирования в {of-mc}]

NOTE: Архивирование -- вытеснение редко используемых данных в архивные таблицы базы данных или отдельные базы данных.

.Группа "Архивирование" содержит инструменты для настройки выполнения отложенного архивирования карточек:
. Блок настроек _Расписание_ -- устанавливает расписание запуска задачи архивирования или разархивирования карточек, у которых установлен признак подготовлен к архивации или разархивации.
+
****
Чтобы отключить автоматическое архивирование или разархивирование, установите переключатель в положение *Не архивировать файлы и карточки автоматически*.

В этом случае нужно нажать на кнопку *Выполнить*, чтобы выполнить архивацию или разархивацию отмеченных карточек.

Чтобы настроить задачу архивирования иным образом, установите переключатель в положение *Нестандартное описание архивирования*.

В этом случае нужно самостоятельно настроить в СУБД параметры выполнения задания архивирования с названием *Название БД {dv}_archive*.
****
+
. Кнопка *Выполнить* -- запускает архивирование немедленно.

[WARNING]
====
После архивирования удаление архивных карточек может быть выполнено только пользователями из группы _Операторы архива_.
====

[#metadata]
== Настройки метаданных

.Настройка метаданных в {of-mc}
image::dev@platform:admin:control-panel-metadata.png[Настройка метаданных в {of-mc}]

.Группа настроек "Метаданные" содержит инструменты преобразования динамических метаданных БД в расширенные:
. Флаг *Используются расширенные метаданные* -- немедленно преобразует динамические метаданные в расширенные. Установка флага -- необратимая операция.
+
[WARNING]
====
Перевод БД на расширенные метаданные является необратимым.

Динамические и расширенные метаданные отличаются способом их хранения в БД. Использование расширенных метаданных в большинстве случаев является предпочтительным.
====
+
. Кнопка *Настройки* -- открывает xref:db-service-tables.adoc[панель настройки расположения служебных таблиц].

[#storage]
=== Внешние хранилища

.Управление внешними хранилищами в {of-mc}
image::dev@platform:admin:db-external-storage.png[Управление внешними хранилищами в {of-mc}]

.Группа настроек "Внешние хранилища" содержит инструменты для управления хранилищами бинарных данных файлов:
. Столбец _Хранилища_ -- поимённый список подключенных к {dv} хранилищ бинарных данных.
+
.При нажатии на строку с именем хранилища открывается окно настройки хранилища со следующими настройками:
* Название хранилища.
* Тип места хранения: БД, файловая система, FileStream, другое.
+
[NOTE]
====
При использовании сетевого диска в качестве внешнего хранилища необходимо указывать UNC-адрес.

include::dev@platform:admin:partial$excerpts.adoc[tags=nofs]
====
+
* Состояние хранилища, которое указывает на возможность работы с ним.
* Максимальный размер хранилища в Гб.
* Разделы хранилища -- определяют классы файлов: основные, архивные, временные, данные которых могут сохраняться в хранилище.
+
. В столбце _Группы хранилищ_ представлен список групп хранилищ и файловых хранилищ, которые входят в данные группы. Группа хранилищ может быть назначена xref:db-storage-default.adoc[группой по умолчанию] для определённых классов файлов. Группа по умолчанию будет использоваться, когда сервер {dv} не смог определить целевую группу хранилищ по правилам помещения в хранилища.
// В таком случае классы файлов будут перечислены справа от названия группы.
. Столбец _Правила помещения в хранилища_ содержит перечень правил, которые определяют способ распределения файлов между группами хранилищ.
+
.В перечне отображаются:
* Название.
* Тип правила, по которому будет проверяться соответствие добавляемого в {dv} файла определённому хранилищу.
* Группа хранилищ, которая будет выбрана для сохранения файла, если выполнены условия правила.
+
Порядок расположения правил в перечне определяет приоритет их применения. Если есть два конкурентных правила, будет выполняться правило с более высоким приоритетом.

Чтобы добавить новое хранилище, группу хранилищ или правило помещения в хранилище, нажмите кнопку image:user:buttons/add.png[Плюс].

Чтобы удалить хранилище, группу хранилищ или правило помещения в хранилище, нажмите кнопку image:user:buttons/x.png[Крестик].

[#archive]
=== Архивирование

Архивирование -- вытеснение редко используемых данных в архивные таблицы базы данных или отдельные базы данных.

.Настройка архивирования в {of-mc}
image::dev@platform:admin:create-panel-archiving.png[Настройка архивирования в {of-mc}]

.Группа "Архивирование" содержит инструменты для настройки отложенного архивирования карточек:
. Группа настроек _Расписание архивирования файлов и карточек_ -- устанавливает расписание запуска задачи архивирования или разархивирования карточек, у которых установлен признак "подготовлен к архивации (разархивации)".
+
****
Чтобы отключить автоматическое архивирование или разархивирование, установите переключатель в положение *Не архивировать файлы и карточки автоматически*. +
В этом случае нужно нажать на кнопку *Запустить архивирование*, чтобы выполнить архивацию или разархивацию отмеченных карточек.

Чтобы настроить задачу архивирования иным образом, установите переключатель в положение *Нестандартное описание архивирования*. +
В этом случае нужно самостоятельно настроить в СУБД параметры выполнения архивирования с названием *Название БД {dv}_archive*.
****
+
. Кнопка *Запустить архивирование* -- запускает архивирование немедленно.

[WARNING]
====
После архивирования удаление архивных карточек может быть выполнено только пользователями из группы _Операторы архива_.
====

[#cache]
=== Кэширование

.Настройки кэширования в Консоли настройки {dv}
image::dev@platform:admin:create-panel-caching.png[Настройки кэширования в Консоли настройки {dv}]

.Группа "Настройки кэширования" содержит элементы настройки способа хранения временных данных сервера {dv} (серверный кэш):
. Раскрывающийся список *_Провайдер_* -- определяет способ кэширования:
+
--
.. *_InMemory_* -- кэш в памяти сервера {dv} (значение по умолчанию).
.. *_Redis_* -- кэш в хранилище Redis.
+
NOTE: Кэш-сервер Redis не поддерживает работу в Windows.
+
.. *_NoCache_* -- серверный кэш отключен.
--
+
****
.Способ кэширования выбирается исходя из конфигурации системы {dv}:
* Конфигурация включает только один экземпляр сервера приложений {dv}.
+
Работает служба *{sss-new}*.
+
Может быть выбран *_InMemory_* (предпочтительно) или *_Redis_*.
+
* Конфигурация включает несколько экземпляров сервера приложений {dv}, выполняющихся параллельно.
+
Работает служба *{sss-new}*. Если параметр _Maximum Worker Processes_ в настройках пула приложений {dv} установлен в значение `2` и более, должен быть выбран вариант *_Redis_*. Если организован кластер серверов {dv}, должен быть выбран вариант *_Redis_*.
+
WARNING: Отключать кэширование не рекомендуется так как это может снизить производительность сервера {dv}.
+
[NOTE]
====
Часть данных сервер {dv} кэширует в файловую систему. На расположение таких данных настройка _Провайдер_ не виляет.
====
+
То же актуально и для псевдокластера. Псевдокластер -- это когда на одном сервере работает более 1 экземпляра процесса `{sss-new}`.
// Например, если у пула {sss-new} в IIS установлено более 1 экземпляра (Maximum worker process > 1) или одновременно работает и {sss-new} в IIS, и Windows-служба {sss-new}
+
****
+
. Поле _Строка подключения_ -- строка подключения к Redis.
+
[NOTE]
====
Пример настройки подключения к Redis приведён в пункте
// xref:redis-cache.adoc[].
====
+
. Флаг `*Включить счетчики производительности*` -- флаг, активирующий функцию записи информации, связанной с работой серверного кэша. Информация записывается в счетчики производительности ОС Windows.

NOTE: Дополнительно ознакомьтесь с информацией в разделе
// "xref:connection-pool-volume.adoc[]".

[#log]
== Журналирование

Группа настроек содержит инструменты для управления стратегией журналирования и архивацией журналов работы.

.Настройка метаданных в Консоли настройки {dv}
image::dev@platform:admin:control-panel-log.png[Настройка метаданных в Консоли настройки {dv}]

Группа "Журналирование"::
Набор переключателей _Настройки логирования_ -- определяет общую стратегию журналирования:
+
* *Логировать все* -- в журнал работы будут попадать все события работы {dv}.
* *Фильтровать лог* -- в журнал работы будут попадать события, выбранные в разделе _Настройки журнала_ в справочнике _Системные настройки_.
* *Логировать только ошибки* -- в журнал работы будут попадать только ошибки {dv}.

Подгруппа "Настройка бэкапа логов"::
Подгруппа определяет параметры архивирования журналов _Платформы_, _Безопасности_ и _Приложений_.
+
Каждый блок параметров содержит следующие: параметры для выгрузки и очистки сообщений журнала:
+
include::partial$excerpts.adoc[tags=store-time]
+
* Параметр _Папка для резервных копий_ позволяет указать папку для резервных копий в файловой системе. Учётная запись, выполняющая сохранение журналов, должна иметь необходимые права на запись в указанную папку.
+
.Параметры резервного копирования/очистки журнала
image::dev@platform:admin:log-settings.png[Параметры резервного копирования/очистки журнала]
+
При нажатии на кнопку *Выбрать* в любом блоке настроек появляется окно выбора папки для резервных копий в файловой системе. Учётная запись, выполняющая сохранение журналов, должна иметь необходимые права на запись в указанную папку.

[#additional]
=== Дополнительные настройки

Группа настроек предназначена для загрузки библиотек карточек и настроек модулей без выполнения полного обновления БД.

Список зависит от модулей, установленных на сервере {dv}.

.Чтобы выполнить загрузку:
. Установите флаги напротив модулей, настройки и библиотеки карточек необходимо загрузить в БД.
. Нажмите кнопку *Начать*.
. Загрузка начнётся сразу после нажатия кнопки.
// . После завершения будет показано сообщение??

[#more]
== Дальнейшее чтение

.Создание, обновление и подключение баз данных через интерфейс {of-mc} см. в разделах:
* xref:db-create.adoc[Создание БД]
* xref:db-update.adoc[Обновление БД]
* xref:db-connect.adoc[Подключение существующей БД]

